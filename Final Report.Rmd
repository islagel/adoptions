---
title: "Final Report"
author: "Isaac Slagel and Jack Welsh"
output:
  pdf_document:
    fig_caption: yes
    fig_height: 3
    fig_width: 4.5
header-includes: \usepackage{dcolumn} \usepackage{float}
editor_options:
  chunk_output_type: console
---

```{r, include = FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(readr)
library(lubridate)
library(kableExtra)
library(knitr)
library(stargazer)
adoptions <- read_csv("adoptions.csv")
```


1. Introduction  A few paragraphs that contain background information, motivation for your research, and a statement of your research goals.  Be sure to incorporate your supporting references into the text.  The purpose of the background is to place your work in the greater context of the literature in the area you are investigating.  Then you should explicitly identify a hypothesis that you will investigate with your analysis.

 # include some more general stuff about the effect fo

  Our project looks into animal shelters in the Dallas area using a dataset provided by the ciry of Dallas through dallasopendata.com. This data includes information about every animal that has been brought into an animal shelter in the Dallas area. There are `r nrow(adoptions)` individual animals in this dataset with with information about when and where the animal was found, the health of the animal on arrival, and whether the animal was adopted, euthinized or transfered. We will be investigating the factors that influence the death of an animal and the ammount of time the animal will spend in the shelter before dying, being adopted, or being transfered. We hyppothesize that pitbulls will be adopted at lower rates and euthinized at higher rates. In addition, we hypothesize that dogs without chips are less likely to survive their time at the animal shelter than dogs with chips. We believe that this work is important to help better understand what factors influence the death of animals in animal shelters and improve the outcomes of for animals in animal shelters.

  # Talk about the literature and recent movements to get rid of pitbulls.
 
  In recent years there has been a movement to regulate pit bulls, many people believe that pitbulls are inherintly not safe and a movement to make them illegal. # add some citations and stuff.
  
  # Also find some papers about chip status.





2. Materials and Methods Three to five paragraphs (or fewer) that…
  -	Briefly describe your data, where it came from (source), definitions of important variables, and how it was collected

We accessed our data from the Dallas Open Data website. This website contains many public datasets, including [animal shelter records](https://www.dallasopendata.com/City-Services/Dallas-Animal-Shelter-Data/7h2m-3um5). Anyone can request an access key to this dataset and then download it. We downloaded the data, selected the variables of interest to us, and created a .csv file in the CreateDataset.Rmd file. Our dataset is saved as adoptions.csv. The initial variables from this dataset are described below in Table 1.

```{r variable table, echo = FALSE}
variables <- c("Variable Name", "Variable Role", "Variable Type", "Range of Values", "Units")

breed <- c("animal_breed", "explanatory", "categorical", "296 unique breeds", "NA")
origin <- c("animal_origin", "explanatory", "categorical", "4 sources of shelter animals", "NA")
type <- c("animal_type", "explanatory", "categorical", "5 species of animal", "NA")
chip <- c("chip_status", "explanatory", "bianary", "(0,1)", "NA")

intake_type <- c("intake_type", "potential confounder", "categorial", "how animal came to be at the shelter", "NA")
outcome_type <- c("outcome_type", "reponse", "categorial", "how animals was removed from shelter", "NA")

intake_condition <- c("intake_condition", "potential confounder", "categorial", "keyword description of animal status at intake", "NA")
outcome_condition <- c("outcome_condition", "potential confounder", "categorial", "keyword description of animal status at outcome", "NA")

intake_date <- c("intake_date", "response", "date", "(2017-10-01, 2019-04-03)", "y-m-d")
outcome_date <- c("outcome_date", "response", "date", "(2017-10-01, 2019-04-03)", "y-m-d")

tab <- rbind(breed, origin, type, chip, intake_type, outcome_type, intake_condition, outcome_condition, intake_date, outcome_date)

colnames(tab) <- variables
rownames(tab) <- NULL

kable(tab, format = "latex", booktabs = T , caption = "Description of Variables") %>%
  column_spec( 4, width = "4cm") %>%
  kable_styling(latex_options = c("striped", "hold_position", "scale_down"))

```

  -	Indicate any modifications made to the data, recoding, or decisions about missing data

We used the imported data described in table 1 to create a fleet of indicator variables: `adopted`, `chip_status`, `summer`, `treatable_intake`, `adopted`, `dead`. These indicator variables were created to streamline our modleing process. They allow us to increase the interpretability of variables with multiple categories (like outcome_type).

In order to fit a binomial regression, we had to summarise our dataset with respect to certain variables we controlled for in our model. One interesting issue that we encountered was the significance of the dataset we fit on SE estimates. If we summarized our data for each specific model, parameter estimates had increased SEs and more insignificant p-values. However, if we fit all of our models on the same, more extensive, summary table, SEs were small and parameters were more likely to be significant. We decided to proceed with the latter option, as it allows us to carry out nested F tests and would be more like a modeling process for true grouped data. This could mean that our SEs are artifically low.

  -	Briefly but thoroughly describe the statistical inference methods used to quantify the association between your outcome and predictor variables (at least one method must have been introduced in Stat 316).  What summary statistics were calculated?  What statistical tests were performed?

We used binomial regression to compare how the outcomes of pitbulls differ from other breeds of dog. In fitting this model we had to control for a plethora of cofounding variables including season of outcome, chip status, and intake condition of the animal. 

We used a Cox Proportional hazard test to compare how the outcomes of ...

  -	Specify strategies employed when building your models


We used findings from our exploratory data analysis to guide decisions on variable selection. Additionally we refered to models fit in the literature to guide decisions about model inclusion.

  -	Do not report results in the Materials and Methods section!


Note:  If you are using a method not covered in Stat 316, you may choose to expand Materials and Methods a bit to describe your statistical method.





3. Results  The meat of your report, which should include…
  -	A general description of your data (completed via your exploratory data analysis)

#### EDA Results: Pitbull


  To look into how pit bulls are handled within animal shelters, we decided to explore how the outcomes of pit bulls may differ from non-pitbulls. Table 1 describes the differences in outcome rates for non-pitbulls compared to pitbulls.


```{r pitbull EDA table, echo = FALSE}
proper=function(x) paste0(toupper(substr(x, 1, 1)), tolower(substring(x, 2)))

adoptions %>%
  filter(dog == 1) %>%
  mutate(outcome = as.factor(outcome_type),
         pitbull = as.factor(pitbull)) %>%
  group_by(pitbull, outcome_type) %>%
  dplyr::count()%>%
  rename("freq"=n)%>%
  group_by(pitbull)%>%
  mutate(freq = freq/ sum(freq))%>%
  spread(outcome_type,freq) %>%
  gather(key = Outcome, value = value, -pitbull) %>%
  spread(key = pitbull, value = value) %>%
  select(1,3,2) %>%
  rename( "Pitbull (%)" = `1`, "Non-Pitbull (%)" = `0`) %>%
  mutate(Outcome = proper(Outcome), `Pitbull (%)` =100*`Pitbull (%)` , `Non-Pitbull (%)`=`Non-Pitbull (%)`*100 )%>%
  arrange(desc(`Pitbull (%)`))%>%
  kable(digits = 2, format = "latex", booktabs = T, caption = "Pitbull Outcomes")%>%
  kable_styling(latex_options =  c("striped", "HOLD_position"))

```


  We see that pit bulls, while only adopted at a slightly lower rate (~5%), are euthanized at well over double the rate of other dogs. Further, we see that other dogs have a much higher chance of being transferred to another facility or returned to their owner. To get a better understanding of this relationship, but we likely need to control for things like chip status, intake condition, and season of outcome in a binomial regression. 
  
  -	A description of the results from your analyses, including interpretations of parameter estimates, tests, and confidence intervals in context.

```{r pitbull model table, results = "asis", echo = FALSE, message=FALSE}

pitbull_binom <- adoptions %>%
  filter(!str_detect(intake_subtype, "(DEAD)|(DIED)")) %>%
  filter(dog == 1) %>%
  mutate(out_dead = outcome_type %in% c("DEAD ON ARRIVAL", "EUTHANIZED", "DIED"),
         summer = ifelse(month %in% c(5, 6, 7, 8, 9), 1, 0),
         chip_status = ifelse(chip_status=="SCAN CHIP", 1, 0),
         contagious=ifelse(grepl(".*[^NON-]CONTAGIOUS", intake_condition),1,0),
         treatable=ifelse(grepl("^TREATABLE.*", intake_condition),1,0)) %>%
  group_by(pitbull, chip_status, summer, contagious, treatable) %>%
  summarize(prop_dead = sum(out_dead)/n(), count = n())


#### MODEL 1 ####

pitbull_model1_quasi <- glm(prop_dead ~ pitbull + chip_status + summer , weights = count, family = quasibinomial, data = pitbull_binom)

#### MODEL 2 ####

pitbull_model2_quasi <- glm(prop_dead ~ pitbull + chip_status +
                      summer + contagious , weights = count,
                    family = quasibinomial, data = pitbull_binom)


#### MODEL 3 ####


pitbull_model3_quasi <- glm(prop_dead ~ pitbull + chip_status +
                      summer + contagious + treatable , weights = count,
                    family = quasibinomial, data = pitbull_binom)

#### TABLE ####
ci.func <- function(model){
  exp(confint(model))
}

p.func <- function(model){
  coef(summary(model))[,4]
}

stargazer(pitbull_model1_quasi, pitbull_model2_quasi, pitbull_model3_quasi,
          title="Modeling Dog Outcomes in Dallas Animal Shelters",
          type='latex',
          align=TRUE,
          header=FALSE,
          table.placement = "H",
          apply.coef = exp,
          ci=TRUE,
          ci.custom = list(ci.func(pitbull_model1_quasi),
                           ci.func(pitbull_model2_quasi),
                           ci.func(pitbull_model3_quasi)),
          p.auto = FALSE,
          p = list(p.func(pitbull_model1_quasi),
                   p.func(pitbull_model2_quasi),
                   p.func(pitbull_model3_quasi)),
          dep.var.labels=c("Proportion of dogs who died"),
          covariate.labels = c("Intercept","Pitbull",
                              "Scannable Chip", "Summer Outcome",
                              "Contagious", "Treatable At Intake",
                            "Overdispersion Parameter"),
          intercept.bottom = FALSE,
          omit.stat = "n",
          add.lines = list(c("Overdisperson Parameter", "139.72", "111.46",  "6.27"),
                           c("Nested F Test","", "F: 5.1142^*", "F: 313.62^{***}")))

```

```{r, include = FALSE}
anova(pitbull_model1_quasi, pitbull_model2_quasi, test = "F")
anova(pitbull_model2_quasi, pitbull_model3_quasi, test = "F")
exp(confint(pitbull_model3_quasi))
```

We see in Table 3 that all of our models have variable estimates that are significant including Model 3 which accounted for whether or not an animal was deemed "treatable" at the time of intake. Further, by two F tests we see each of our models is an improvement on the one before it (Model 1 $\rightarrow$ Model 2: F = 5.1141, p-value = 0.031) (Model 2 $\rightarrow$ Model 3: F = 313.62, p-value <<< .05). 

Procceding with model 3 as our best model of dog outcomes from the animal shelter, we glean several insights about the relationships between certain characteristics of dogs and those animal's outcomes from the shelter. For instance, if a dog is a pitbull, we expect it's odds of leaving the animal shelter dead increase by 348%, after controlling for chip status, season, and intake condition. Further, if a dog is a pitbull we are 95% confident that the true increase in odds of death at outcome is between 302% and 402%. Yikes! On the other hand, if a dog comes into the shelter with a scannable chip, we expect the animals odds of dying within the shelter system to drop by about 22%, after controlling for pitbull, season, and intake condition. Interestingly enough, if a dog has its outcome in the summer, the odds of that outcome being death are about 47% higher, controlling for breed, chip status, and intake condition.




  -	While you should interpret tests, confidence intervals, and coefficients in this section, you should not editorialize here!  Save that for the Discussion.




4. Discussion  A few paragraphs that:

  -	Begin with an accurate summary statement; describe how the results help answer your research questions and what was most interesting from your analysis.  In fact, the first paragraph of the Discussion is very important – in professional journals, it is often the first and sometimes the only paragraph that is read in a paper.  After the first sentence highlights primary results, the remainder of the first paragraph might compare your results to others in the literature or include interesting secondary results.
  
  -	Discuss possible implications of the results in the context of the research question.
  
  -	Make a statement regarding potential confounding variables in your study
  
  -	Make a statement about the generalizability of your results.  Don’t give generic statements of possible causation and generalizability, but thoughtfully discuss relevant issues – confounding variables, representativeness of the sample, etc.
  
  Conclusions about animal outcomes of animals in shelters from this report can only be extended to the city of Dallas. While our sample size is totally representative for this population, we cannot account for differences that would be encountered in other municipalities, say higher adoption rates or less stigma against certain breeds of dog. Further, we cannot be sure that the trends observed in this paper will continue into the future. Anti-pitbull advocacy groups like [National Pitbull Victims Awareness](https://www.nationalpitbullvictimawareness.org/) and pro-pitbull advocacy groups like [Love-a-Bull](http://love-a-bull.org/resources/statistics-pit-bull-bites-community-safety/) are at odds trying to sway public opinion and policy reguarding the handling of pitbulls in animal shelters. If changes in public percecption of pitbulls or the policy that surrounds them changes, our model will lose it's generalizability to Dallas. 
  
  -	Identify any limitations of your study. Discuss the potential impact of such limitations on the conclusions.
  
  One limitation of our study is that we do not know what happens to animals after they have been transferred out of the animal shelter. In our analysis we have viewed this outcome as a live outcome, but for all we know these animals could go on to another shelter where they are euthanized. Depending on the validity of our assumption, we could be adding some bias to our conclusions. Additionally, there is not consistant infomration on the criteria used by shelters to evaluate animals intake conditions. We look for key words that indicated the health of the animal. However we are not sure how consistant these evaluations are across all Dallas animal shelters. 
  
  -	Identify strengths and weaknesses of your analysis.
  
  -	Make suggestions for future research. Identify important next steps that a researcher could take to build on your work.
  
  Future work could be done in Dallas to help minimize the number of animals which need to be euthanized. By identifying specific at-risk groups of animals, more resources could be allocated to advocating for these animals or transfering them to other No-Kill shelters. We would recomend any additional research to work directly with the Dallas Animal Shelter group. By having a direct contact with the group doing data collection, a statistician will be able to better identify pressing issues of the group and verify certain assumptions that we have not been able to verify. 
  
  -	Do not include test statistics or p-values in this section.






5. Annotated Appendix
  -	Tables and figures that are informative but were not referenced specifically in the main report.  Include a short annotation – one or two sentences on what they show.
  -	R scripts and output (annotated) so that I can trace how you constructed your final data set, what models you ran to produce the results quoted in your report, and what intermediate models you also considered.
  -	Description of statistical modeling steps that were not included in the main body of your report.  Possible entries here include: How you handled missing data. Evaluation of assumptions. Outlier analysis and how you decided to deal with any outliers along with rationale for your decision. Describe hypotheses testing you performed during model building and how you decided on the explanatory variables you ultimately included in your final model. Assessment of the final model.
  -	How you went from the model output in R to interpretations in your report (e.g. exponentiate coefficients, then take inverse)
  -	Anticipate questions someone might have after reading your report, and make sure those questions can be answered with information in the appendix.
  -	A citation for each reference article (in APA format or something similar) you included in your proposal.  Also include a link, if appropriate.  Remember that you must have the entire paper and not just an abstract, and at least two must be from peer-reviewed journals.

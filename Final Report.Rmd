---
title: "Final Report"
author: "Isaac Slagel and Jack Welsh"
output:
  pdf_document:
    fig_caption: yes
    fig_height: 3
    fig_width: 4.5
header-includes: \usepackage{dcolumn} \usepackage{float}
editor_options:
  chunk_output_type: console
---

```{r, include = FALSE}
library(tidyverse)
library(readr)
library(lubridate)
library(kableExtra)
library(knitr)
library(lme4)
library(stargazer)
adoptions <- read_csv("adoptions.csv")
```


## Introduction  


  According to an ASPCA estimate, over 6.5 millions animals enter a shelter system every year. (Cite 1). After entering the shelter system animals are either rehabilitated and sent to homes or euthanized. Animal shelters, while running mostly on revenue from donations and adoption fees, routinely run into perminant defieciets and must be supported with money from local governments (Cite 2). Knowing more about the outcomes of animals from these shelters could help us minimize the percent of animals that need to be euthanized. Further, by identifying which animals are less likely to be adopted, we can help shelters allocate resources to minimize the time these animals spend in the shelter system.

  Our research looks into animal shelters in the Dallas area using a dataset provided by the city of Dallas on dallasopendata.com. This data includes information about every animal that has been brought into an animal shelter in the Dallas area. There are `r nrow(adoptions)` individual animals in this dataset with with information about when and where the animal was found, the health of the animal on arrival, and whether the animal was adopted, euthinized or transfered.

  Recent research on animal shelters have consistantly shown that outcomes for pitbulls are consistantly worse than other dog breeds (Patronek & Crowe 2018, Lepper et al 2002). We are interested in seeing if these this trends exist in the Dallas animal shelter system.



## Materials and Methods


We accessed our data from the Dallas Open Data website. This website contains many public datasets, including [animal shelter records](https://www.dallasopendata.com/City-Services/Dallas-Animal-Shelter-Data/7h2m-3um5). Anyone can request an access key to this dataset and then download it. We downloaded the data, selected the variables of interest to us, and created a .csv file in the CreateDataset.Rmd file. Our dataset is saved as adoptions.csv. The initial variables from this dataset are described below in Table 1.

```{r variable table, echo = FALSE}
variables <- c("Variable Name", "Variable Role", "Variable Type", "Range of Values", "Units")

breed <- c("animal_breed", "explanatory", "categorical", "296 unique breeds", "NA")
origin <- c("animal_origin", "explanatory", "categorical", "4 sources of shelter animals", "NA")
type <- c("animal_type", "explanatory", "categorical", "5 species of animal", "NA")
chip <- c("chip_status", "explanatory", "bianary", "(0,1)", "NA")

intake_type <- c("intake_type", "potential confounder", "categorial", "how animal came to be at the shelter", "NA")
outcome_type <- c("outcome_type", "reponse", "categorial", "how animals was removed from shelter", "NA")

intake_condition <- c("intake_condition", "potential confounder", "categorial", "keyword description of animal status at intake", "NA")
outcome_condition <- c("outcome_condition", "potential confounder", "categorial", "keyword description of animal status at outcome", "NA")

intake_date <- c("intake_date", "response", "date", "(2017-10-01, 2019-04-03)", "y-m-d")
outcome_date <- c("outcome_date", "response", "date", "(2017-10-01, 2019-04-03)", "y-m-d")

tab <- rbind(breed, origin, type, chip, intake_type, outcome_type, intake_condition, outcome_condition, intake_date, outcome_date)

colnames(tab) <- variables
rownames(tab) <- NULL

kable(tab, format = "latex", booktabs = T , caption = "Description of Variables") %>%
  column_spec( 4, width = "4cm") %>%
  kable_styling(latex_options = c("striped", "hold_position", "scale_down"))

```


  We used the imported data described in Table 1 to create a fleet of indicator variables: `adopted`, `chip_status`, `summer`, `treatable_intake`, `adopted`, `dead`. These indicator variables were created to streamline our modleing process. They allow us to increase the interpretability of variables with multiple categories (like outcome_type).


  In order to fit a binomial regression, we had to summarise our dataset with respect to certain variables we controlled for in our model. One interesting issue that we encountered was the significance of the dataset we fit on SE estimates. If we summarized our data for each specific model, parameter estimates had increased SEs and more insignificant p-values. However, if we fit all of our models on the same, more extensive, summary table, SEs were small and parameters were more likely to be significant. We decided to proceed with the latter option, as it allows us to carry out nested F tests and would be more like a modeling process for true grouped data. This could mean that our SEs are artifically low.


  We used binomial regression to compare how the outcomes of pitbulls differ from other breeds of dog. In fitting this model we had to control for a plethora of cofounding variables including season of outcome, chip status, and intake condition of the animal. We also considered a multilevel model to account for difference in district correlation. Next we used a binomial regression to compare how the outcomes of dogs and cats differ, after controlling for season of outcome, chip status, and intake condition of the animal. We used findings from our exploratory data analysis to guide decisions on variable selection. Additionally we refered to models fit in the literature to guide decisions about model inclusion.

  We also fit multilevel logistic regression models to compare ourcomes after accounting for correlation within city council districts. Our modeling process took on a similar approach to the binomial regression, we examined differences in odds of dying for pitbulls and non-pitbulls after accounting for differences in chip status, and season.  

## Results


#### EDA Results: Pitbull


  To look into how pit bulls are handled within animal shelters, we decided to explore how the outcomes of pit bulls may differ from non-pitbulls. Table 1 describes the differences in outcome rates for non-pitbulls compared to pitbulls.


```{r pitbull EDA table, echo = FALSE}
proper=function(x) paste0(toupper(substr(x, 1, 1)), tolower(substring(x, 2)))

adoptions %>%
  filter(dog == 1) %>%
  mutate(outcome = as.factor(outcome_type),
         pitbull = as.factor(pitbull)) %>%
  group_by(pitbull, outcome_type) %>%
  dplyr::count()%>%
  rename("freq"=n)%>%
  group_by(pitbull)%>%
  mutate(freq = freq/ sum(freq))%>%
  spread(outcome_type,freq) %>%
  gather(key = Outcome, value = value, -pitbull) %>%
  spread(key = pitbull, value = value) %>%
  select(1,3,2) %>%
  rename( "Pitbull (%)" = `1`, "Non-Pitbull (%)" = `0`) %>%
  mutate(Outcome = proper(Outcome), `Pitbull (%)` =100*`Pitbull (%)` , `Non-Pitbull (%)`=`Non-Pitbull (%)`*100 )%>%
  arrange(desc(`Pitbull (%)`))%>%
  kable(digits = 2, format = "latex", booktabs = T, caption = "Pitbull Outcomes")%>%
  kable_styling(latex_options =  c("striped", "HOLD_position"))

```


  We see that pit bulls, while only adopted at a slightly lower rate (~5%), are euthanized at well over double the rate of other dogs. Further, we see that other dogs have a much higher chance of being transferred to another facility or returned to their owner. To get a better understanding of this relationship, but we likely need to control for things like chip status, intake condition, and season of outcome in a binomial regression.

#### EDA Results: Effect of Council District

```{r, echo=FALSE}
mlm_dead<- adoptions %>%
  filter(!str_detect(intake_subtype, "(DEAD)|(DIED)")) %>%
  filter(dog == 1) %>%
  mutate(out_dead = outcome_type %in% c("DEAD ON ARRIVAL", "EUTHANIZED", "DIED"),
         summer = ifelse(month %in% c(5, 6, 7, 8, 9), 1, 0),
         chip_status = ifelse(chip_status=="SCAN CHIP", 1, 0),
         contagious=ifelse(grepl(".*[^NON-]CONTAGIOUS", intake_condition),1,0),
         treatable=ifelse(grepl("^TREATABLE.*", intake_condition),1,0))

mlm_dead %>%
  group_by(council_district)%>%
  summarise(prop_dead = sum(out_dead)/n())%>%
  filter(!is.na(council_district))%>%
  ggplot(aes(x=as.factor(council_district), y = prop_dead)) +
  geom_bar(stat = "identity")+
  xlab("City Conucil District")+
  ylab("Proportion Dead")+
  ggtitle("Proportion Dead by Council District")


```




#### EDA Results: Dog and Cat Differences


#### Binomial Models for Dog Outcomes

```{r pitbull model table, results = "asis", echo = FALSE, message=FALSE}

pitbull_binom <- adoptions %>%
  filter(!str_detect(intake_subtype, "(DEAD)|(DIED)")) %>%
  filter(dog == 1) %>%
  mutate(out_dead = outcome_type %in% c("DEAD ON ARRIVAL", "EUTHANIZED", "DIED"),
         summer = ifelse(month %in% c(5, 6, 7, 8, 9), 1, 0),
         chip_status = ifelse(chip_status=="SCAN CHIP", 1, 0),
         contagious=ifelse(grepl(".*[^NON-]CONTAGIOUS", intake_condition),1,0),
         treatable=ifelse(grepl("^TREATABLE.*", intake_condition),1,0)) %>%
  group_by(pitbull, chip_status, summer, contagious, treatable) %>%
  summarize(prop_dead = sum(out_dead)/n(), count = n())


#### MODEL 1 ####

pitbull_model1_quasi <- glm(prop_dead ~ pitbull + chip_status + summer , weights = count, family = quasibinomial, data = pitbull_binom)

#### MODEL 2 ####

pitbull_model2_quasi <- glm(prop_dead ~ pitbull + chip_status +
                      summer + contagious , weights = count,
                    family = quasibinomial, data = pitbull_binom)


#### MODEL 3 ####


pitbull_model3_quasi <- glm(prop_dead ~ pitbull + chip_status +
                      summer + contagious + treatable , weights = count,
                    family = quasibinomial, data = pitbull_binom)

#### TABLE ####
ci.func <- function(model){
  exp(confint(model))
}

p.func <- function(model){
  coef(summary(model))[,4]
}

stargazer(pitbull_model1_quasi, pitbull_model2_quasi, pitbull_model3_quasi,
          title="Modeling Dog Outcomes in Dallas Animal Shelters",
          type='latex',
          align=TRUE,
          header=FALSE,
          table.placement = "H",
          apply.coef = exp,
          ci=TRUE,
          ci.custom = list(ci.func(pitbull_model1_quasi),
                           ci.func(pitbull_model2_quasi),
                           ci.func(pitbull_model3_quasi)),
          p.auto = FALSE,
          p = list(p.func(pitbull_model1_quasi),
                   p.func(pitbull_model2_quasi),
                   p.func(pitbull_model3_quasi)),
          dep.var.labels=c("Proportion of dogs who died"),
          covariate.labels = c("Intercept","Pitbull",
                              "Scannable Chip", "Summer Outcome",
                              "Contagious", "Treatable At Intake",
                            "Overdispersion Parameter"),
          intercept.bottom = FALSE,
          omit.stat = "n",
          add.lines = list(c("Overdisperson Parameter", "139.72", "111.46",  "6.27"),
                           c("Nested F Test","", "F: 5.1142^*", "F: 313.62^{***}")))

```

```{r, include = FALSE}
anova(pitbull_model1_quasi, pitbull_model2_quasi, test = "F")
anova(pitbull_model2_quasi, pitbull_model3_quasi, test = "F")
exp(confint(pitbull_model3_quasi))
```

We see in Table 3 that all of our models have variable estimates that are significant including Model 3 which accounted for whether or not an animal was deemed "treatable" at the time of intake. Further, by two F tests we see each of our models is an improvement on the one before it (Model 1 $\rightarrow$ Model 2: F = 5.1141, p-value = 0.031) (Model 2 $\rightarrow$ Model 3: F = 313.62, p-value <<< .05).

Procceding with model 3 as our best model of dog outcomes from the animal shelter, we glean several insights about the relationships between certain characteristics of dogs and those animal's outcomes from the shelter. For instance, if a dog is a pitbull, we expect it's odds of leaving the animal shelter dead increase by 348%, after controlling for chip status, season, and intake condition. Further, if a dog is a pitbull we are 95% confident that the true increase in odds of death at outcome is between 302% and 402%. Yikes! On the other hand, if a dog comes into the shelter with a scannable chip, we expect the animals odds of dying within the shelter system to drop by about 22%, after controlling for pitbull, season, and intake condition. Interestingly enough, if a dog has its outcome in the summer, the odds of that outcome being death are about 47% higher, controlling for breed, chip status, and intake condition.


#### Multilevel Model for Dog Outcomes

Our model has two levels, 

  -Level 1
  $$ Y_{ij}=a_i+b_i*summer_{ij}+c_i*pitbull_{ij}+d_i*chipstatus_{ij}+\epsilon_{ij}$$

  -Level 2
  $a_i=\alpha_0+u_i$
  $b_i=\beta_0+v_i$
  $c_i=\gamma_0+w_i$
  $d_i=\delta_0+x_i$
  
  where
  
  $\begin{bmatrix} u_i \\ v_i \\ w_i\\ x_i \end{bmatrix}=N\begin{pmatrix} \begin{bmatrix} 0 \\ 0 \\ 0 \\ 0 \end{bmatrix}, \begin{bmatrix} \sigma_u^2 & & & \\ \sigma_{uv} & \sigma_v^2 & & \\ \sigma_{uvw} &\sigma_{vw} & \sigma_w^2 & \\ \sigma_{uvwx} & \sigma{vwx} & \sigma_{wx} & \sigma_x^2 \end{bmatrix} \end{pmatrix} $

This model was chosen based on information from our exploratory data analysis. Again, we found that

```{r, echo=FALSE, include=F}
mod.2.dead=glmer(out_dead~summer+chip_status+pitbull+(1|council_district), data=mlm_dead, family = "binomial")
summary(mod.2.dead)
```

```{r, results="asis"}
stargazer(mod.2.dead,
          add.lines = list(c("Between District $\\sigma$", "0.1408")),
          title="Predicting Dead Outcomes and Adoption Outcomes with Multilevel Structure with Level 1 Predictors",
          type='latex',
          align=TRUE,
          header=FALSE,
          intercept.bottom = FALSE)

```



#### Modeling Dog and Cat Differences

 In our modeling of Dog and Cat differences we used used binomial regression. To model this we considered the following model:

\begin{equation}
log(\frac{p_{i}}{1-p_{i}})=\beta_0+\beta_1 DogYN + \beta_i(Confounder_i).
\end{equation}

We considered several models with different confounders controled for based on findings in the literature and our EDA. We were not able to find any significant difference in the odds of death between dogs and cat. We conclude that there is not evidence of a significant difference between dogs and cats in odds of dying in an animal shelter after accounting for chip_status, season of outcome, and intake condition. These models can be found in the Dog Cat portion of our appendix.

## Discussion

  -	Begin with an accurate summary statement; describe how the results help answer your research questions and what was most interesting from your analysis.  In fact, the first paragraph of the Discussion is very important – in professional journals, it is often the first and sometimes the only paragraph that is read in a paper.  After the first sentence highlights primary results, the remainder of the first paragraph might compare your results to others in the literature or include interesting secondary results.

  -	Discuss possible implications of the results in the context of the research question.

  -	Make a statement regarding potential confounding variables in your study

  -	Make a statement about the generalizability of your results.  Don’t give generic statements of possible causation and generalizability, but thoughtfully discuss relevant issues – confounding variables, representativeness of the sample, etc.

  Conclusions about animal outcomes of animals in shelters from this report can only be extended to the city of Dallas. While our sample size is totally representative for this population, we cannot account for differences that would be encountered in other municipalities, say higher adoption rates or less stigma against certain breeds of dog. Further, we cannot be sure that the trends observed in this paper will continue into the future. Anti-pitbull advocacy groups like [National Pitbull Victims Awareness](https://www.nationalpitbullvictimawareness.org/) and pro-pitbull advocacy groups like [Love-a-Bull](http://love-a-bull.org/resources/statistics-pit-bull-bites-community-safety/) are at odds trying to sway public opinion and policy reguarding the handling of pitbulls in animal shelters. If changes in public percecption of pitbulls or the policy that surrounds them changes, our model will lose it's generalizability to Dallas.

  -	Identify any limitations of your study. Discuss the potential impact of such limitations on the conclusions.

  One limitation of our study is that we do not know what happens to animals after they have been transferred out of the animal shelter. In our analysis we have viewed this outcome as a live outcome, but for all we know these animals could go on to another shelter where they are euthanized. Depending on the validity of our assumption, we could be adding some bias to our conclusions. Additionally, there is not consistant infomration on the criteria used by shelters to evaluate animals intake conditions. We look for key words that indicated the health of the animal. However we are not sure how consistant these evaluations are across all Dallas animal shelters.

  -	Identify strengths and weaknesses of your analysis.

  -	Make suggestions for future research. Identify important next steps that a researcher could take to build on your work.

  Future work could be done in Dallas to help minimize the number of animals which need to be euthanized. By identifying specific at-risk groups of animals, more resources could be allocated to advocating for these animals or transfering them to other No-Kill shelters. We would recomend any additional research to work directly with the Dallas Animal Shelter group. By having a direct contact with the group doing data collection, a statistician will be able to better identify pressing issues of the group and verify certain assumptions that we have not been able to verify.


# Works Cited

1. https://www.aspca.org/animal-homelessness/shelter-intake-and-surrender
2. https://rucore.libraries.rutgers.edu/rutgers-lib/38418/PDF/1/play/

Patronek, G. J., & Crowe, A. (2018). Factors Associated with High Live Release for Dogs at a Large, Open-Admission, Municipal Shelter. Animals : an open access journal from MDPI, 8(4), 45. doi:10.3390/ani8040045

[Lepper, M., Kass, P. H., & Hart, L. A. (2002). Prediction of adoption versus euthanasia among dogs and cats in a California animal shelter. Journal of Applied Animal Welfare Science, 5(1), 29-42.](https://www.tandfonline.com/doi/abs/10.1207/S15327604JAWS0501_3)

[Posage, J. M., Bartlett, P. C., & Thomas, D. K. (1998). Determining factors for successful adoption of dogs from an animal shelter. Journal of the American Veterinary Medical Association, 213(4), 478-482.](https://europepmc.org/abstract/med/9713528)

[Lampe, R., & Witte, T. H. (2015). Speed of dog adoption: Impact of online photo traits. Journal of applied animal welfare science, 18(4), 343-354.](https://www.tandfonline.com/doi/abs/10.1080/10888705.2014.982796)

5. Annotated Appendix
  -	Tables and figures that are informative but were not referenced specifically in the main report.  Include a short annotation – one or two sentences on what they show.
  -	R scripts and output (annotated) so that I can trace how you constructed your final data set, what models you ran to produce the results quoted in your report, and what intermediate models you also considered.
  -	Description of statistical modeling steps that were not included in the main body of your report.  Possible entries here include: How you handled missing data. Evaluation of assumptions. Outlier analysis and how you decided to deal with any outliers along with rationale for your decision. Describe hypotheses testing you performed during model building and how you decided on the explanatory variables you ultimately included in your final model. Assessment of the final model.
  -	How you went from the model output in R to interpretations in your report (e.g. exponentiate coefficients, then take inverse)
  -	Anticipate questions someone might have after reading your report, and make sure those questions can be answered with information in the appendix.
  -	A citation for each reference article (in APA format or something similar) you included in your proposal.  Also include a link, if appropriate.  Remember that you must have the entire paper and not just an abstract, and at least two must be from peer-reviewed journals.

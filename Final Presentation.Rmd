---
title: "Dallas Animal Shelter Analysis"
author: "Jack Welsh and Isaac Slagel"
date: "May 16, 2019"
header-includes: \usepackage{dcolumn} \usepackage{float} \usepackage{longtable,booktabs} \usepackage{colortbl}
output:
  beamer_presentation:
    theme: "Copenhagen"
    slide_level: 3
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
library(here)
```

```{r, include = FALSE}
library(tidyverse)
library(readr)
library(lubridate)
library(survival)
library(survminer)
library(kableExtra)
library(knitr)
library(lme4)
library(stargazer)

data_path <- here::here("adoptions.csv")
adoptions <- read_csv(data_path)
here::here()
```

# Introduction

### Background

![Pitbull](pitbull.jpg)


### EDA 

```{r pitbull EDA table, echo = FALSE}
proper=function(x) paste0(toupper(substr(x, 1, 1)), tolower(substring(x, 2)))


adoptions %>%
  filter(dog == 1) %>%
  mutate(outcome = as.factor(outcome_type),
         pitbull = as.factor(pitbull)) %>%
  group_by(pitbull, outcome_type) %>%
  dplyr::count()%>%
  rename("freq"=n)%>%
  group_by(pitbull)%>%
  mutate(freq = freq/ sum(freq))%>%
  spread(outcome_type,freq) %>%
  gather(key = Outcome, value = value, -pitbull) %>%
  spread(key = pitbull, value = value) %>%
  select(1,3,2) %>%
  rename( "Pitbull (%)" = `1`, "Non-Pitbull (%)" = `0`) %>%
  mutate(Outcome = proper(Outcome), `Pitbull (%)` =100*`Pitbull (%)` , `Non-Pitbull (%)`=`Non-Pitbull (%)`*100 )%>%
  arrange(desc(`Pitbull (%)`))%>%
  kable(digits = 2,
        linesep = "",
        format = "latex",
        booktabs = T,
        caption = "Pitbull Outcomes")%>%
  kable_styling(latex_options =  c("striped", "HOLD_position"), font_size = 8)
```



# Methods

### Quasibinomial Model 

 - Modeling the odds of dying at outcome 
 - Interested in the `pitbull` coefficient 
 - Need to control for:
    - season
    - chip status
    - intake condition

### Quasibinomial Model 

```{r pitbull model table, results = "asis", echo = FALSE, message=FALSE}


pitbull_binom <- adoptions %>%
  filter(!str_detect(intake_subtype, "(DEAD)|(DIED)")) %>%
  filter(dog == 1) %>%
  mutate(out_dead = outcome_type %in% c("DEAD ON ARRIVAL", "EUTHANIZED", "DIED"),
         summer = ifelse(month %in% c(5, 6, 7, 8, 9), 1, 0),
         chip_status = ifelse(chip_status=="SCAN CHIP", 1, 0),
         contagious=ifelse(grepl(".*[^NON-]CONTAGIOUS", intake_condition),1,0),
         treatable=ifelse(grepl("^TREATABLE.*", intake_condition),1,0)) %>%
  group_by(pitbull, chip_status, summer, contagious, treatable) %>%
  summarize(prop_dead = sum(out_dead)/n(), count = n())


#### MODEL 1 ####

pitbull_model1_quasi <- glm(prop_dead ~ pitbull + chip_status + summer , weights = count, family = quasibinomial, data = pitbull_binom)

#### MODEL 2 ####

pitbull_model2_quasi <- glm(prop_dead ~ pitbull + chip_status +
                      summer + contagious , weights = count,
                    family = quasibinomial, data = pitbull_binom)


#### MODEL 3 ####


pitbull_model3_quasi <- glm(prop_dead ~ pitbull + chip_status +
                      summer + contagious + treatable , weights = count,
                    family = quasibinomial, data = pitbull_binom)

ci.func <- function(model){
  exp(confint(model))
}

p.func <- function(model){
  coef(summary(model))[,4]
}


stargazer(pitbull_model1_quasi, pitbull_model2_quasi, pitbull_model3_quasi,
          type='latex',
          align=TRUE,
          header=FALSE,
          table.placement = "H",
          apply.coef = exp,
          ci=TRUE,
          ci.custom = list(ci.func(pitbull_model1_quasi),
                           ci.func(pitbull_model2_quasi),
                           ci.func(pitbull_model3_quasi)),
          p.auto = FALSE,
          p = list(p.func(pitbull_model1_quasi),
                   p.func(pitbull_model2_quasi),
                   p.func(pitbull_model3_quasi)),
          dep.var.labels=c("Proportion of dogs who died"),
          covariate.labels = c("Intercept","Pitbull",
                              "Scannable Chip", "Summer Outcome",
                              "Contagious", "Treatable At Intake",
                            "Overdispersion Parameter"),
          intercept.bottom = FALSE,
          font.size = "tiny",
          omit.stat = "n",
          add.lines = list(c("Overdisperson Parameter", "139.72", "111.46",  "6.27"),
                           c("Nested F Test","", "F: 5.1142^*", "F: 313.62^{***}")))
```


### Cox Proportional Hazards 

- Used for looking at time till event.
- Follows the general form $h(t)=h_0(t)*\exp\{b_1*x_1+b_2*x_2+....+b_p*x_p\}.$
- Only assumes that the hazards are proportional. 

# Results

### Quasibinomial Results

### Cox Proportional Hazard Results

```{r, echo=FALSE, message=FALSE, include=FALSE, fig.align="center"}
adoptions_1 <- read_csv(data_path)

adoptions_surv=adoptions_1%>%
  mutate(intake_date=as.Date(intake_date),
         outcome_date=as.Date(outcome_date))%>%
  mutate(days_in_shelter=difftime(outcome_date, intake_date, units = "days"),
         days_in_shelter=as.numeric(days_in_shelter)+1)%>%
  filter(outcome_type!="DEAD ON ARRIVAL")%>%
  mutate(death=ifelse(outcome_type=="DIED", 1, 0),
         death=ifelse(outcome_type=="EUTHANIZED", 1, death),
         censored=ifelse(death==1, 2, 1))%>%
  filter(animal_type=="DOG")%>%
  mutate(animal_breed=as.factor(animal_breed))%>%
  mutate(healthy_intake=ifelse(grepl("^HEALTHY.*",intake_condition),1,0),
         contagious_intake=ifelse(grepl(".*[^NON-]CONTAGIOUS", intake_condition),1,0),
         untreatable_intake=ifelse(grepl(".*(UNTREATABLE).*", intake_condition),1,0),
         treatable_intake=ifelse(grepl("^TREATABLE.*", intake_condition),1,0),
         manageable_intake=ifelse(grepl(".*MANAGEABLE.*", intake_condition),1,0),
         rehabitable_intake=ifelse(grepl(".*REHABILITABLE.*", intake_condition),1,0),
         normal_intake=ifelse(grepl(".*NORMAL.*", intake_condition),1,0),
         chip_status = ifelse(chip_status=="SCAN CHIP", 1, 0),
         summer = ifelse(month %in% c(5, 6, 7, 8, 9), 1, 0))
```

```{r, echo=FALSE, include=FALSE}
adop.1.1=adoptions_surv%>%
  filter(summer==1, chip_status==1)
adop.0.1=adoptions_surv%>%
  filter(summer==0, chip_status==1)
adop.1.0=adoptions_surv%>%
  filter(summer==1, chip_status==0)
adop.0.0=adoptions_surv%>%
  filter(summer==0, chip_status==0)

surv.mod.1.1=coxph(Surv(days_in_shelter, censored)~pitbull,
               data=adop.1.1)
surv.mod.0.1=coxph(Surv(days_in_shelter, censored)~pitbull,
                   data=adop.0.1)
surv.mod.1.0=coxph(Surv(days_in_shelter, censored)~pitbull,
                   data=adop.1.0)
surv.mod.0.0=coxph(Surv(days_in_shelter, censored)~pitbull,
                   data=adop.0.0)
```


```{r, results = "asis", echo = FALSE, message=FALSE}

ci.func <- function(model){
  exp(confint(model))
}


stargazer(surv.mod.1.1, surv.mod.1.0, surv.mod.0.1, surv.mod.0.0,
          align=TRUE,
          title = "$b_1$ Estimates for Each Strata",
          header=FALSE,
          table.placement = "H",
          apply.coef = exp,
          ci=TRUE,
          ci.custom = list(ci.func(surv.mod.1.1), ci.func(surv.mod.1.0), ci.func(surv.mod.0.1), ci.func(surv.mod.0.1), ci.func(surv.mod.0.0)),
          dep.var.caption = "Strata",
          dep.var.labels = "",
          model.numbers = FALSE,
          column.labels = c("Summer and Chip", "Summer and No Chip", "Not Summer and Chip", "Neither Summer or Chip"),
          omit.stat = "all",
          font.size = "tiny"
          )
```

#Discussion 


### Discussion

- Pitbulls do die more often in animal shelters
- Pitbulls die at a higher rate in animal shelters


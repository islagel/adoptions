---
title: 'Stage 2: Exploratory Data Analysis'
author: "Isaac Slagel and Jack Welsh"
date: "4/18/2019"
output:
  pdf_document:
    fig_caption: yes
    fig_height: 3
    fig_width: 4.5
  html_document:
    df_print: paged
header-includes: \usepackage{dcolumn}
                  \usepackage{float}
editor_options:
  chunk_output_type: console
---

```{r, include=FALSE}
library(tidyverse)
library(readr)
library(lubridate)
library(kableExtra)
library(knitr)
library(stargazer)
adoptions <- read_csv("adoptions.csv")
```

#Main Report 


```{r, results = "asis", echo = FALSE}
pitbull_binom <- adoptions %>%
  filter(!str_detect(intake_subtype, "(DEAD)|(DIED)")) %>%
  filter(dog == 1) %>%
  mutate(out_dead = outcome_type %in% c("DEAD ON ARRIVAL", "EUTHANIZED", "DIED"),
         summer = ifelse(month %in% c(5, 6, 7, 8, 9), 1, 0),
         chip_status = ifelse(chip_status=="SCAN CHIP", 1, 0),
         contagious=ifelse(grepl(".*[^NON-]CONTAGIOUS", intake_condition),1,0),
         treatable=ifelse(grepl("^TREATABLE.*", intake_condition),1,0)) %>%
  group_by(pitbull, chip_status, summer, month, contagious, treatable) %>%
  summarize(prop_dead = sum(out_dead)/n(), count = n())

pitbull_model1_quasi <- glm(prop_dead ~ pitbull + chip_status + summer , weights = count, family = quasibinomial, data = pitbull_binom)

pitbull_model2_quasi <- glm(prop_dead ~ pitbull + chip_status + 
                      summer + contagious , weights = count, 
                    family = quasibinomial, data = pitbull_binom)

pitbull_model3_quasi <- glm(prop_dead ~ pitbull + chip_status + 
                      summer + contagious + treatable , weights = count, 
                    family = quasibinomial, data = pitbull_binom)

stargazer(pitbull_model1_quasi, pitbull_model2_quasi, pitbull_model3_quasi, 
          title="Modeling Dog Outcomes in Dallas Animal Shelters", 
          align=TRUE, 
          keep.stat="n",
          ci=TRUE, 
          ci.level=0.95, 
          apply.coef = exp,
          apply.se   = exp,
          dep.var.labels=c("Proportion of dogs who died"),
          header=FALSE, 
          type='latex',
          covariate.labels = c("Pitbull", "Scannable Chip", "Summer Outcome",
                               "Contagious", "Treatable At Intake", "Intercept"),
          intercept.bottom = FALSE)

```




#Annotated Appendix

### Pitbulls

One of our research interests was to look into how different species of dogs fare in the animal shelter system. Specifically, we were interested in why pitbulls are more likely to be dead at the outcome of their time in the shelter. Does this trend continue after controlling for other variables in our dataset? 

Initially we fit a model which factors in the chip status, whether or not the outcome was in the summer, and whether the dog was a pitbull or not. 

```{r}
pitbull_binom <- adoptions %>%
  filter(!str_detect(intake_subtype, "(DEAD)|(DIED)")) %>%
  filter(dog == 1) %>%
  mutate(out_dead = outcome_type %in% c("DEAD ON ARRIVAL", "EUTHANIZED", "DIED"),
         summer = ifelse(month %in% c(5, 6, 7, 8, 9), 1, 0)) %>%
  mutate(chip_status = ifelse(chip_status=="SCAN CHIP", 1, 0)) %>%
  group_by(pitbull, chip_status, summer, month) %>%
  summarize(prop_dead = sum(out_dead)/n(), count = n())


pitbull_model1_binom <- glm(prop_dead ~ pitbull + chip_status + summer , weights = count, family = binomial, data = pitbull_binom)

pitbull_model1_quasi <- glm(prop_dead ~ pitbull + chip_status + summer , weights = count, family = quasibinomial, data = pitbull_binom)

summary(pitbull_model1_binom)
exp(confint(pitbull_model1_binom))

summary(pitbull_model1_quasi)
exp(confint(pitbull_model1_quasi))
```

Initially we see that all variables included have a significant relationship to the proportion of dogs who are dead at the end of their time in the shelter, even after inflating our standard errors to account for the variance structure of our data.  


Next lets try to control for whether or not a animal was contagious when it was brought into the shelter. 

```{r}
pitbull_binom <- adoptions %>%
  filter(!str_detect(intake_subtype, "(DEAD)|(DIED)")) %>%
  filter(dog == 1) %>%
  mutate(out_dead = outcome_type %in% c("DEAD ON ARRIVAL", "EUTHANIZED", "DIED"),
         summer = ifelse(month %in% c(5, 6, 7, 8, 9), 1, 0),
         chip_status = ifelse(chip_status=="SCAN CHIP", 1, 0),
         contagious=ifelse(grepl(".*[^NON-]CONTAGIOUS", intake_condition),1,0)) %>%
  group_by(pitbull, chip_status, summer, month, contagious) %>%
  summarize(prop_dead = sum(out_dead)/n(), count = n())

pitbull_model2_binom <- glm(prop_dead ~ pitbull + chip_status + 
                      summer + contagious, weights = count, 
                    family = binomial, data = pitbull_binom)

pitbull_model2_quasi <- glm(prop_dead ~ pitbull + chip_status + 
                      summer + contagious , weights = count, 
                    family = quasibinomial, data = pitbull_binom)

summary(pitbull_model2_binom)
exp(confint(pitbull_model2_binom))

summary(pitbull_model2_quasi)
exp(confint(pitbull_model2_quasi))
```

Next lets try to control for whether or not a animal was treatable when it was brought into the shelter. 

```{r}
pitbull_binom <- adoptions %>%
  filter(!str_detect(intake_subtype, "(DEAD)|(DIED)")) %>%
  filter(dog == 1) %>%
  mutate(out_dead = outcome_type %in% c("DEAD ON ARRIVAL", "EUTHANIZED", "DIED"),
         summer = ifelse(month %in% c(5, 6, 7, 8, 9), 1, 0),
         chip_status = ifelse(chip_status=="SCAN CHIP", 1, 0),
         contagious=ifelse(grepl(".*[^NON-]CONTAGIOUS", intake_condition),1,0),
         treatable=ifelse(grepl("^TREATABLE.*", intake_condition),1,0)) %>%
  group_by(pitbull, chip_status, summer, month, contagious, treatable) %>%
  summarize(prop_dead = sum(out_dead)/n(), count = n())

pitbull_model3_binom <- glm(prop_dead ~ pitbull + chip_status + 
                      summer + contagious + treatable, weights = count, 
                    family = binomial, data = pitbull_binom)

pitbull_model3_quasi <- glm(prop_dead ~ pitbull + chip_status + 
                      summer + contagious + treatable , weights = count, 
                    family = quasibinomial, data = pitbull_binom)

summary(pitbull_model3_binom)
exp(confint(pitbull_model3_binom))

summary(pitbull_model3_quasi)
exp(confint(pitbull_model3_quasi))
```

### Dogs vs Cats

```{r}
cat_dog_binom <- adoptions %>%
  filter(!str_detect(intake_subtype, "(DEAD)|(DIED)")) %>%
  filter(dog == 1 | cat == 1) %>%
  mutate(out_dead = outcome_type %in% c("DEAD ON ARRIVAL", "EUTHANIZED", "DIED"),
         summer = ifelse(month %in% c(5, 6, 7, 8, 9), 1, 0))%>%
  mutate(chip_status = ifelse(chip_status=="SCAN CHIP", 1, 0)) %>%
  group_by(dog, chip_status, summer, stray) %>%
  summarize(prop_dead = sum(out_dead)/n(), count = n())

####### MODEL 1: dog ######### 

dogcat_model1_binom <- glm(prop_dead ~ dog, weights = count, family = binomial, data = cat_dog_binom)

dogcat_model1_quasi <- glm(prop_dead ~ dog, weights = count, family = quasibinomial, data = cat_dog_binom)

summary(dogcat_model1_binom)
exp(confint(dogcat_model1_binom))

summary(dogcat_model1_quasi)
exp(confint(dogcat_model1_quasi))

####### MODEL 2: summer ######### 

dogcat_model2_binom <- glm(prop_dead ~ summer, weights = count, family = binomial, data = cat_dog_binom)

dogcat_model2_quasi <- glm(prop_dead ~ summer, weights = count, family = quasibinomial, data = cat_dog_binom)

summary(dogcat_model2_binom)
exp(confint(dogcat_model2_binom))

summary(dogcat_model2_quasi)
exp(confint(dogcat_model2_quasi))


####### MODEL 3: chip ###### 

dogcat_model3_binom <- glm(prop_dead ~ chip_status, weights = count, family = binomial, data = cat_dog_binom)

dogcat_model3_quasi <- glm(prop_dead ~ chip_status, weights = count, family = quasibinomial, data = cat_dog_binom)

summary(dogcat_model3_binom)
exp(confint(dogcat_model3_binom))

summary(dogcat_model3_quasi)
exp(confint(dogcat_model3_quasi))

####### MODEL 4: summer + dog + summer:dog ###### 

dogcat_model4_binom <- glm(prop_dead ~ summer+dog+ summer:dog, weights = count, family = binomial, data = cat_dog_binom)

dogcat_model4_quasi <- glm(prop_dead ~ summer+dog+ summer:dog, weights = count, family = quasibinomial, data = cat_dog_binom)

summary(dogcat_model4_binom)
exp(confint(dogcat_model4_binom))

summary(dogcat_model4_quasi)
exp(confint(dogcat_model4_quasi))

####### MODEL 5: stray ###### 

dogcat_model5_binom <- glm(prop_dead ~ stray, weights = count, family = binomial, data = cat_dog_binom)

dogcat_model5_quasi <- glm(prop_dead ~ stray, weights = count, family = quasibinomial, data = cat_dog_binom)

summary(dogcat_model5_binom)
exp(confint(dogcat_model5_binom))

summary(dogcat_model5_quasi)
exp(confint(dogcat_model5_quasi))
```

### Multilevel on Council District
